<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Book Your Stay | Houseboat Canberra</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#0f1113;
  --card:#15181c;
  --muted:#9aa4b2;
  --accent:#25D366;
  --border:#2a2f36;
}

*{box-sizing:border-box}
body{
  margin:0;
  background:var(--bg);
  color:#fff;
  font-family:Inter,system-ui;
}

.wrapper{
  max-width:1100px;
  margin:auto;
  padding:40px 20px;
}

h1{font-size:2rem;margin-bottom:5px}
.subtitle{color:var(--muted);margin-bottom:30px}

.grid{
  display:grid;
  grid-template-columns:2fr 1fr;
  gap:30px;
}

.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:14px;
  padding:24px;
}

.card h2{font-size:1.2rem;margin-bottom:20px}

.field{margin-bottom:15px}
label{font-size:.9rem;color:var(--muted)}

input,select{
  width:100%;
  padding:12px;
  margin-top:6px;
  background:#1d2026;
  border:1px solid var(--border);
  border-radius:8px;
  color:#fff;
  font-size:1rem;
}

.row{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:15px;
}

.summary{position:sticky;top:20px}

.price{
  font-size:2rem;
  font-weight:700;
  color:var(--accent);
  margin:10px 0;
  transition:transform .25s ease;
}
.price.updated{transform:scale(1.05)}

.small{font-size:.85rem;color:var(--muted)}

button{
  width:100%;
  padding:14px;
  margin-top:20px;
  border-radius:10px;
  border:none;
  font-size:1rem;
  font-weight:600;
  background:var(--accent);
  cursor:pointer;
}

button:disabled{
  opacity:.4;
  cursor:not-allowed;
}

.error{color:#ff6b6b}

@media(max-width:900px){
  .grid{grid-template-columns:1fr}
}
</style>
</head>

<body>
<div class="wrapper">
  <h1>Book Your Stay</h1>
  <div class="subtitle">Secure your houseboat experience in just a few steps</div>

  <div class="grid">

    <!-- LEFT -->
    <div class="card">
      <h2>Stay Details</h2>

      <div class="field">
        <label>Room Type</label>
        <select id="room" disabled>
          <option>Loading room types…</option>
        </select>
      </div>

      <div class="field">
        <label>Meal Plan</label>
        <select id="meal" disabled>
          <option>Loading meal plans…</option>
        </select>
      </div>

      <div class="row">
        <div class="field">
          <label>Check-in</label>
          <input type="date" id="checkin">
        </div>
        <div class="field">
          <label>Check-out</label>
          <input type="date" id="checkout">
        </div>
      </div>

      <div class="small" id="nightInfo"></div>

      <div class="row">
        <div class="field">
          <label>Adults</label>
          <div id="capacityNote" class="small" style="margin-bottom:4px; color:var(--muted);">
            Room has capacity of Max 3 adults or 2 adults and 2 children
          </div>
          <input type="number" id="adults" min="1" value="1">
        </div>
        <div class="field">
          <label>Children</label>
          <input type="number" id="children" min="0" value="0">
        </div>
      </div>


      <h2 style="margin-top:30px">Guest Information</h2>

      <div class="field">
        <label>Full Name</label>
        <input type="text" id="name">
      </div>

      <div class="field">
        <label>Email</label>
        <input type="email" id="email">
      </div>

      <div class="field">
        <label>Phone / WhatsApp</label>
        <input type="tel" id="phone">
      </div>

      <div class="field">
        <label>Special Requests</label>
        <input type="text" id="requests">
      </div>
    </div>

    <!-- RIGHT -->
    <div class="card summary">
      <h2>Price Summary</h2>
      <div class="small">Total payable amount</div>
      <div id="priceBox" class="price">$ 0</div>
      <div class="small">Inclusive of taxes</div>

      <button id="bookBtn" disabled>Confirm Booking</button>

      <div class="small" style="margin-top:15px">
        ✔ Instant confirmation<br>
        ✔ No hidden charges<br>
        ✔ Secure booking
      </div>
    </div>

  </div>
</div>

<!-- Booking Modal -->
<div id="bookingPopup" class="popup">
  <div class="popup-content">
    <span id="popupClose" class="close">&times;</span>
    <h2 id="popupTitle"></h2>
    <p id="popupMessage"></p>
  </div>
</div>

<style>
.popup {
  display: none;
  position: fixed;
  z-index: 999;
  left: 0; top: 0;
  width: 100%; height: 100%;
  background-color: rgba(0,0,0,0.6);
}
.popup-content {
  background-color: #15181c;
  margin: 15% auto;
  padding: 20px;
  border-radius: 12px;
  max-width: 450px;
  text-align: center;
  color: #fff;
}
.popup-content h2 { color: #25D366; }
.close {
  color: #fff;
  float: right;
  font-size: 28px;
  cursor: pointer;
}
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {

  const API = "https://script.google.com/macros/s/AKfycbwe8HXWyDzrSYtqDNqX4bShBNll8uJ427_-Cj3cpwHJO2S9wS41UWFenpytZOl1GwP7/exec";

  const room = document.getElementById("room");
  const meal = document.getElementById("meal");
  const checkin = document.getElementById("checkin");
  const checkout = document.getElementById("checkout");
  const adults = document.getElementById("adults");
  const children = document.getElementById("children");
  const name = document.getElementById("name");
  const email = document.getElementById("email");
  const phone = document.getElementById("phone");
  const requests = document.getElementById("requests");
  const priceBox = document.getElementById("priceBox");
  const nightInfo = document.getElementById("nightInfo");
  const bookBtn = document.getElementById("bookBtn");

  const popup = document.getElementById("bookingPopup");
  const popupTitle = document.getElementById("popupTitle");
  const popupMessage = document.getElementById("popupMessage");
  const popupClose = document.getElementById("popupClose");

  popupClose.onclick = () => popup.style.display = "none";
  window.onclick = e => { if (e.target === popup) popup.style.display = "none"; };

  function showPopup(title, message) {
    popupTitle.textContent = title;
    popupMessage.textContent = message;
    popup.style.display = "block";
  }

  /* ---------- INIT ---------- */
  fetch(`${API}?action=init`)
    .then(res => res.json())
    .then(data => {
      if (!data.rooms || !data.meals) throw new Error("Invalid init data");

      room.innerHTML = `<option value="">Select Room</option>`;
      meal.innerHTML = `<option value="">Select Meal</option>`;

      data.rooms.forEach(r => room.add(new Option(r[1], r[0])));
      data.meals.forEach(m => meal.add(new Option(m[1], m[0])));

      room.disabled = false;
      meal.disabled = false;
    })
    .catch(err => {
      console.error("INIT ERROR:", err);
      showPopup("Server Error", "Unable to load booking data");
    });

  /* ---------- AVAILABILITY ---------- */
  function updateNights() {
    if(checkin.value && checkout.value){
      const nights = Math.ceil((new Date(checkout.value)-new Date(checkin.value))/(1000*60*60*24));
      nightInfo.textContent = nights > 0 ? `${nights} night(s)` : '';
    } else {
      nightInfo.textContent = '';
    }
  }

  function checkAvailabilityBeforePrice() {
    bookBtn.disabled = true;
    priceBox.textContent = "$ 0";
    updateNights();

    if (!room.value || !checkin.value || !checkout.value) return;
    if (new Date(checkout.value) <= new Date(checkin.value)) {
      priceBox.textContent = "Invalid date range";
      return;
    }

    fetch(`${API}?action=availability&room=${room.value}&checkin=${checkin.value}&checkout=${checkout.value}`)
      .then(res => res.json())
      .then(data => {
        if (!data.available) {
          priceBox.textContent = "Not available";
          return;
        }
        calculatePrice();
        bookBtn.disabled = false;
      })
      .catch(() => {
        priceBox.textContent = "Availability error";
      });
  }

  /* ---------- PRICE ---------- */
  function calculatePrice() {
    if (!room.value || !meal.value || !checkin.value || !checkout.value) return;

    fetch(`${API}?action=calculate&room=${room.value}&meal=${meal.value}&checkin=${checkin.value}&checkout=${checkout.value}&adults=${adults.value}&children=${children.value}`)
      .then(res => res.json())
      .then(data => {
        if (data.error) {
          priceBox.textContent = "Price error";
          bookBtn.disabled = true;
        } else {
          priceBox.textContent = "$ " + data.total;
          priceBox.classList.add("updated");
          setTimeout(()=>priceBox.classList.remove("updated"),300);
        }
      });
  }

  [room, checkin, checkout].forEach(el => el.addEventListener("change", checkAvailabilityBeforePrice));
  [meal, adults, children].forEach(el => el.addEventListener("change", calculatePrice));
  [checkin, checkout].forEach(el => el.addEventListener("change", updateNights));

  /* ---------- SAVE BOOKING ---------- */
  bookBtn.addEventListener("click", () => {
    if (!room.value || !meal.value || !checkin.value || !checkout.value || !name.value) {
      showPopup("Oops!", "Please fill all required fields");
      return;
    }

    const payload = new URLSearchParams({
      action: "save",
      room: room.value,
      meal: meal.value,
      checkin: checkin.value,
      checkout: checkout.value,
      adults: adults.value,
      children: children.value,
      name: name.value,
      email: email.value,
      phone: phone.value,
      requests: requests.value,
      total: priceBox.textContent.replace("$ ","")
    });

    fetch(API, { method: "POST", body: payload })
      .then(res => res.json())
      .then(data => {
        if (data.status === "success") {
          showPopup("Thank You!", "Your booking is confirmed ✅");

          const msg = encodeURIComponent(
            `Hello ${name.value}, your booking for ${room.value} from ${checkin.value} to ${checkout.value} is confirmed!`
          );
          window.open(`https://wa.me/${phone.value.replace(/\D/g,"")}?text=${msg}`, "_blank");

          room.value = meal.value = checkin.value = checkout.value = "";
          adults.value = 1; children.value = 0;
          priceBox.textContent = "$ 0";
          nightInfo.textContent = '';
          bookBtn.disabled = true;
        } else {
          showPopup("Sorry!", data.error || "Booking failed");
        }
      })
      .catch(err => {
        console.error(err);
        showPopup("Server Error", "Please try again later");
      });
  });

});
</script>

</body>
</html>
