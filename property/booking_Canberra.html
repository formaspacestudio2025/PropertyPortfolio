<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Book Your Stay | Houseboat Canberra</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#0f1113;
  --card:#15181c;
  --muted:#9aa4b2;
  --accent:#25D366;
  --border:#2a2f36;
}

*{box-sizing:border-box}
body{
  margin:0;
  background:var(--bg);
  color:#fff;
  font-family:Inter,system-ui;
}

.wrapper{
  max-width:1100px;
  margin:auto;
  padding:40px 20px;
}

h1{font-size:2rem;margin-bottom:5px}
.subtitle{color:var(--muted);margin-bottom:30px}

.grid{
  display:grid;
  grid-template-columns:2fr 1fr;
  gap:30px;
}

.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:14px;
  padding:24px;
}

.card h2{font-size:1.2rem;margin-bottom:20px}

.field{margin-bottom:15px}
label{font-size:.9rem;color:var(--muted)}

input,select{
  width:100%;
  padding:12px;
  margin-top:6px;
  background:#1d2026;
  border:1px solid var(--border);
  border-radius:8px;
  color:#fff;
  font-size:1rem;
}

.row{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:15px;
}

.summary{position:sticky;top:20px}

.price{
  font-size:2rem;
  font-weight:700;
  color:var(--accent);
  margin:10px 0;
  transition:transform .25s ease;
}
.price.updated{transform:scale(1.05)}

.small{font-size:.85rem;color:var(--muted)}

button{
  width:100%;
  padding:14px;
  margin-top:20px;
  border-radius:10px;
  border:none;
  font-size:1rem;
  font-weight:600;
  background:var(--accent);
  cursor:pointer;
}

button:disabled{
  opacity:.4;
  cursor:not-allowed;
}

.error{color:#ff6b6b}

@media(max-width:900px){
  .grid{grid-template-columns:1fr}
}
</style>
</head>

<body>
<div class="wrapper">
  <h1>Book Your Stay</h1>
  <div class="subtitle">Secure your houseboat experience in just a few steps</div>

  <div class="grid">

    <!-- LEFT -->
    <div class="card">
      <h2>Stay Details</h2>

      <div class="field">
        <label>Room Type</label>
        <select id="room" disabled>
          <option>Loading room types…</option>
        </select>
      </div>

      <div class="field">
        <label>Meal Plan</label>
        <select id="meal" disabled>
          <option>Loading meal plans…</option>
        </select>
      </div>

      <div class="row">
        <div class="field">
          <label>Check-in</label>
          <input type="date" id="checkin">
        </div>
        <div class="field">
          <label>Check-out</label>
          <input type="date" id="checkout">
        </div>
      </div>

      <div class="small" id="nightInfo"></div>

      <div class="row">
        <div class="field">
          <label>Adults</label>
          <input type="number" id="adults" min="1" value="1">
        </div>
        <div class="field">
          <label>Children</label>
          <input type="number" id="children" min="0" value="0">
        </div>
      </div>

      <h2 style="margin-top:30px">Guest Information</h2>

      <div class="field">
        <label>Full Name</label>
        <input type="text" id="name">
      </div>

      <div class="field">
        <label>Email</label>
        <input type="email" id="email">
      </div>

      <div class="field">
        <label>Phone / WhatsApp</label>
        <input type="tel" id="phone">
      </div>

      <div class="field">
        <label>Special Requests</label>
        <input type="text" id="requests">
      </div>
    </div>

    <!-- RIGHT -->
    <div class="card summary">
      <h2>Price Summary</h2>
      <div class="small">Total payable amount</div>
      <div id="priceBox" class="price">$ 0</div>
      <div class="small">Inclusive of taxes</div>

      <button id="bookBtn" disabled>Confirm Booking</button>

      <div class="small" style="margin-top:15px">
        ✔ Instant confirmation<br>
        ✔ No hidden charges<br>
        ✔ Secure booking
      </div>
    </div>

  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  const API = "https://script.google.com/macros/s/AKfycbwe8HXWyDzrSYtqDNqX4bShBNll8uJ427_-Cj3cpwHJO2S9wS41UWFenpytZOl1GwP7/exec";

  const room = document.getElementById("room");
  const meal = document.getElementById("meal");
  const checkin = document.getElementById("checkin");
  const checkout = document.getElementById("checkout");
  const adults = document.getElementById("adults");
  const children = document.getElementById("children");
  const priceBox = document.getElementById("priceBox");
  const bookBtn = document.getElementById("bookBtn");

  room.disabled = true;
  meal.disabled = true;
  bookBtn.disabled = true;

  // Global room capacity limits
  let roomCapacity = {
    adults: 3,   // Max adults: 3
    children: 2  // Max children: 2
  };

  /* ---------- INIT LOAD ---------- */
  fetch(`${API}?action=init`)
    .then(res => res.json())
    .then(data => {
      room.innerHTML = "";
      meal.innerHTML = "";

      // Dynamically add room types
      data.rooms.forEach(r => {
        if (r[0] === 'R1') {
          room.add(new Option("Deluxe Room 1", 'R1'));
        } else if (r[0] === 'R2') {
          room.add(new Option("Deluxe Room 2", 'R2'));
        } else if (r[0] === 'R3') {
          room.add(new Option("Family Suite", 'R3'));
        }
      });

      data.meals.forEach(m => {
        meal.add(new Option(m[1], m[0]));
      });

      room.disabled = false;
      meal.disabled = false;
    })
    .catch(() => {
      room.innerHTML = "<option>Error loading rooms</option>";
      meal.innerHTML = "<option>Error loading meals</option>";
    });

  /* ---------- EVENT LISTENERS ---------- */
  room.addEventListener("change", () => {
    updateAdultsAndChildrenLimits();
    checkAvailabilityBeforePrice();
  });

  [room, checkin, checkout].forEach(el => {
    el.addEventListener("change", checkAvailabilityBeforePrice);
  });

  [meal, adults, children].forEach(el => {
    el.addEventListener("change", calculatePrice);
  });

  /* ---------- UPDATE ADULTS AND CHILDREN LIMITS BASED ON ROOM SELECTION ---------- */
  function updateAdultsAndChildrenLimits() {
    // No need to differentiate by room, as we are using the same limits across all rooms
    const maxAdults = roomCapacity.adults;
    const maxChildren = roomCapacity.children;

    // Update the adults and children limits based on selection
    adults.max = maxAdults;
    children.max = maxChildren;

    // Automatically adjust the values if the user exceeds the allowed limits
    if (parseInt(adults.value) > maxAdults) {
      adults.value = maxAdults;
    }
    if (parseInt(children.value) > maxChildren) {
      children.value = maxChildren;
    }
  }

  /* ---------- AVAILABILITY CHECK ---------- */
  function checkAvailabilityBeforePrice() {
    bookBtn.disabled = true;
    priceBox.textContent = "$ 0";

    // Ensure room, checkin, and checkout are all provided
    if (!room.value || !checkin.value || !checkout.value) return;

    // Ensure valid date range
    if (new Date(checkout.value) <= new Date(checkin.value)) {
      priceBox.textContent = "Invalid date range";
      return;
    }

    // Fetch availability and handle response
    fetch(`${API}?action=availability`
      + `&room=${room.value}` + `&checkin=${checkin.value}` + `&checkout=${checkout.value}`)
      .then(res => res.json())
      .then(data => {
        if (!data.available) {
          priceBox.textContent = "Not available";
          bookBtn.disabled = true;
          return;
        }

        // If available, calculate the price and enable the book button
        calculatePrice();
        bookBtn.disabled = false;
      })
      .catch(() => {
        priceBox.textContent = "Availability error";
      });
  }

  /* ---------- PRICE CALCULATION ---------- */
  function calculatePrice() {
    if (!checkin.value || !checkout.value || !room.value || !meal.value) {
      priceBox.textContent = "$ 0";
      return;
    }

    fetch(`${API}?action=calculate`
      + `&checkin=${checkin.value}`
      + `&checkout=${checkout.value}`
      + `&room=${room.value}`
      + `&meal=${meal.value}`
      + `&adults=${adults.value}`
      + `&children=${children.value}`)
      .then(res => res.json())
      .then(data => {
        if (data.error) {
          priceBox.textContent = "Price error";
          return;
        }

        priceBox.textContent = "$ " + data.total;
      })
      .catch(() => {
        priceBox.textContent = "Price error";
      });
  }

});
</script>



</body>
</html>
