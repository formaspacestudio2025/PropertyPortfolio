<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Book | Houseboat Canberra</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{background:#0f1113;color:#fff;font-family:Inter}
.container{max-width:900px;margin:auto;padding:40px}
.panel{background:#15181c;padding:25px;border-radius:12px}
input,select,button{
  width:100%;padding:12px;margin-top:10px;
  background:#222;border:1px solid #333;color:#fff;
  font-size:1rem;
}
button{background:#25D366;border:none;cursor:pointer}
#priceBox{margin-top:20px;font-size:1.3rem;color:#25D366}
.error{color:#ff6b6b}
</style>
</head>

<body>
<div class="container">
  <h1>Book Your Stay</h1>
  <div class="panel">

    <label>Room Type</label>
    <select id="room"><option>Loading...</option></select>

    <label>Meal Plan</label>
    <select id="meal"><option>Loading...</option></select>

    <label>Check-in Date</label>
    <input type="date" id="checkin">

    <label>Check-out Date</label>
    <input type="date" id="checkout">

    <label>Number of Adults</label>
    <input type="number" id="adults" min="1" value="1">

    <label>Number of Children</label>
    <input type="number" id="children" min="0" value="0">

    <label>Full Name</label>
    <input type="text" id="name">

    <label>Email</label>
    <input type="email" id="email">

    <label>Phone / WhatsApp</label>
    <input type="tel" id="phone">

    <label>Special Requests</label>
    <input type="text" id="requests">

    <div id="priceBox">Total Amount: ₹ 0</div>
    <button type="button" id="bookBtn">Confirm Booking</button>
  </div>
</div>

<script>
const API = "https://script.google.com/macros/s/YOUR_DEPLOYED_SCRIPT_ID/exec";
const $ = id => document.getElementById(id);

let lastTotal = 0;

// Load dynamic room and meal options
async function loadOptions() {
  try {
    const res = await fetch(API, {
      method: "POST",
      body: JSON.stringify({ action: "getOptions" })
    });
    const data = await res.json();

    // Rooms
    const roomSelect = $("room");
    roomSelect.innerHTML = '';
    data.rooms.forEach(r => {
      const opt = document.createElement("option");
      opt.value = r;
      opt.textContent = r;
      roomSelect.appendChild(opt);
    });

    // Meals
    const mealSelect = $("meal");
    mealSelect.innerHTML = '';
    data.meals.forEach(m => {
      const opt = document.createElement("option");
      opt.value = m.code;
      opt.textContent = `${m.code} - ${m.name}`;
      mealSelect.appendChild(opt);
    });

    calculate(); // initial calculation

  } catch(err) {
    console.error("Error loading options:", err);
  }
}

// Attach calculate on change
["room","meal","checkin","checkout","adults","children"]
  .forEach(id => $(id).addEventListener("change", calculate));

async function calculate() {
  const priceBox = $("priceBox");
  lastTotal = 0;

  const checkin = $("checkin").value;
  const checkout = $("checkout").value;

  if (!checkin || !checkout || new Date(checkout) <= new Date(checkin)) {
    priceBox.innerText = "Total Amount: ₹ 0";
    priceBox.className = "";
    return;
  }

  const payload = {
    action: "calculate",
    checkin,
    checkout,
    adults: Number($("adults").value || 1),
    children: Number($("children").value || 0),
    room: $("room").value,
    meal: $("meal").value
  };

  try {
    const res = await fetch(API, { method: "POST", body: JSON.stringify(payload) });
    const data = await res.json();
    if (data.error) throw new Error(data.error);
    if (typeof data.total !== "number") throw new Error("Invalid server response");

    lastTotal = data.total;
    priceBox.className = "";
    priceBox.innerText = `Total Amount: ₹ ${data.total}`;
  } catch(err) {
    console.error("CALC ERROR:", err);
    priceBox.className = "error";
    priceBox.innerText = "Error calculating price";
  }
}

// Booking
$("bookBtn").addEventListener("click", async () => {
  if (!lastTotal) { alert("Please calculate price before booking."); return; }

  const payload = {
    action: "book",
    checkin: $("checkin").value,
    checkout: $("checkout").value,
    adults: $("adults").value,
    children: $("children").value,
    room: $("room").value,
    meal: $("meal").value,
    total: lastTotal,
    name: $("name").value,
    phone: $("phone").value,
    email: $("email").value,
    requests: $("requests").value
  };

  try {
    const res = await fetch(API, { method: "POST", body: JSON.stringify(payload) });
    const data = await res.json();
    alert(data.success ? "Booking Confirmed!" : "Booking Failed");
  } catch(err) {
    console.error("BOOK ERROR:", err);
    alert("Server error. Please try again.");
  }
});

// Load options on page load
loadOptions();
</script>
</body>
</html>
